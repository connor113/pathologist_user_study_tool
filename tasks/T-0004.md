# tasks/T-0004.md — Backend API Foundation (≤6 hours)

**Goal:** Build Node.js + Express + TypeScript backend with PostgreSQL database; implement authentication, slide management, and event logging API endpoints; test all routes locally.

**AC:** 
- PostgreSQL database created with 4 tables (users, slides, sessions, events) per schema in spec.md
- Express server runs on `localhost:3001` with CORS enabled for frontend origin
- Auth endpoints (`/api/auth/login`, `/api/auth/logout`, `/api/auth/me`) working with JWT httpOnly cookies and bcrypt password hashing
- Slide endpoints (`/api/slides`, `/api/slides/:slideId/manifest`, `/api/slides/:slideId/start`) return mock data or query database
- Event endpoints (`/api/sessions/:sessionId/events`, `/api/sessions/:sessionId/complete`) insert events and update sessions in database
- Admin endpoints (`/api/admin/users`, `/api/admin/progress`, `/api/admin/export/csv`) return user stats and CSV export
- JWT auth middleware protects all routes except `/api/auth/login`
- Database migrations runnable via script or manual SQL execution
- All endpoints tested with curl or Postman; return correct HTTP status codes and JSON responses

**Constraints:** 
- Node.js 18+ with TypeScript; Express 4.x; `pg` library for PostgreSQL
- bcrypt salt rounds = 10; JWT expiry = 7 days
- Use parameterized queries ($1, $2) to prevent SQL injection
- Store secrets in `.env` file (gitignored); provide `.env.example` template
- Project structure: `backend/src/` with subdirs `routes/`, `middleware/`, `db/`, `utils/`

**Test notes:** 
- Use local PostgreSQL instance (Docker or native install)
- Create test admin and pathologist accounts via SQL insert
- Insert 2-3 mock slides into database for testing
- Test full auth flow: login → access protected route → logout → access fails
- Test event batch insert: send array of 10 events, verify all inserted
- Test CSV export: insert events, download CSV, verify format matches spec

**Deliverables:**
- `backend/src/index.ts` - Express app entry point
- `backend/src/db/schema.sql` - Database schema (copy from spec.md)
- `backend/src/db/migrations/001_initial.sql` - Initial migration script
- `backend/src/routes/auth.ts` - Auth routes
- `backend/src/routes/slides.ts` - Slide routes
- `backend/src/routes/admin.ts` - Admin routes
- `backend/src/middleware/auth.ts` - JWT verification middleware
- `backend/src/utils/db.ts` - Database connection pool
- `backend/package.json` - Dependencies (express, pg, bcrypt, jsonwebtoken, cors, dotenv)
- `backend/tsconfig.json` - TypeScript config
- `backend/.env.example` - Environment variable template
- `backend/README.md` - Setup instructions for local development

