# T-0012: Patch Extraction System ⬜ PENDING

**Goal:** Extract image patches corresponding to clicked positions and calculate visible patches for context modeling.

**Status:** ⬜ Pending (~5 hours)

## Deliverables

- `analysis/scripts/extract_patches.py` - Patch extraction from DZI/OpenSlide
- `analysis/scripts/calculate_visible_patches.py` - Visible patch calculator
- `analysis/scripts/lattice_utils.py` - Shared coordinate utilities
- Updated `analysis/requirements.txt`
- Updated `analysis/README.md`

## Acceptance Criteria

### extract_patches.py
- [ ] Extract patches centered on click coordinates from logged events
- [ ] Usage: `python extract_patches.py --csv events.csv --slide slide_id --tiles tiles/slide_id_files/ --output patches/`
- [ ] For each `cell_click` event:
  1. Read `click_x0`, `click_y0`, `zoom_level`, `dzi_level` from event
  2. Calculate patch bounds centered on click position
  3. Convert to DZI tile coordinates for that level
  4. Read and stitch necessary tiles to extract patch_px × patch_px region
  5. Save as PNG: `{slide_id}_{session_id}_{timestamp}_{zoom_level}x.png`
- [ ] Generate index JSON: `patches_index.json` with metadata
- [ ] Validate extracted patch dimensions match expected size
- [ ] Report: "Extracted N patches from M events"

### OpenSlide Alternative
- [ ] If `--source-slide` argument provided: use original SVS/NDPI file instead of DZI
- [ ] Use OpenSlide Python to read regions directly from pyramid
- [ ] Document both approaches; default to DZI (faster, matches viewer)

### calculate_visible_patches.py
- [ ] Usage: `python calculate_visible_patches.py --csv events.csv --output visible_patches.json`
- [ ] For each event with viewport bounds:
  1. Calculate grid cell_size at that zoom level
  2. Determine all complete cells within viewport rectangle
  3. Store as JSON with cell coordinates and bounds
- [ ] Report: "Calculated visible patches for N events"

## Constraints

- DZI approach (default): requires local tile directory
- OpenSlide approach (optional): requires openslide-python + original slide files
- Batch processing with progress bars (tqdm)
- Memory-efficient: process one event at a time
- Validate coordinates before extraction

## Test Notes

- Extract patches from 10 sample clicks in CSV
- Visually inspect alignment (do patches show clicked regions?)
- Test with events at different zoom levels (2.5×, 5×, 20×, 40×)

## Notes

Cell indices (i, j) have been removed from event logging. Patch extraction now uses exact click coordinates (`click_x0`, `click_y0`) which allows extraction of any size patches centered on the click point. This is more flexible than grid-aligned extraction.
