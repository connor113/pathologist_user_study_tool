# tasks/T-0012.md — Patch Extraction System (≤5 hours)

**Goal:** Extract image patches corresponding to clicked cells and calculate visible patches for context modeling.

**AC:**
- Python script `analysis/scripts/extract_patches.py`:
  - Usage: `python extract_patches.py --csv events.csv --slide slide_id --tiles tiles/slide_id_files/ --output patches/`
  - For each `cell_click` event: extract patch from DZI tiles
  - Process:
    1. Read (i, j, zoom_level, dzi_level) from event
    2. Calculate cell center in level-0 coordinates
    3. Convert to DZI tile coordinates for that level
    4. Read and stitch necessary tiles to extract patch_px × patch_px region
    5. Save as PNG: `{slide_id}_{session_id}_{event_timestamp}_{zoom_level}x_{i}_{j}.png`
  - Generate index JSON: `patches_index.json` with metadata (event_id, timestamp, zoom_level, cell indices, file path)
  - Validate extracted patch dimensions match expected size (256×256 or 512×512)
  - Report: "Extracted N patches from M events"

- **Alternative approach (OpenSlide):** 
  - If `--source-slide` argument provided: use original SVS/NDPI file instead of DZI
  - Use OpenSlide Python to read regions directly from pyramid
  - Convert level-0 coordinates to appropriate pyramid level
  - Extract patch at native resolution
  - **Decision:** Document both approaches; default to DZI (faster, matches viewer); OpenSlide option for "ground truth" patches

- Python script `analysis/scripts/calculate_visible_patches.py`:
  - Usage: `python calculate_visible_patches.py --csv events.csv --output visible_patches.json`
  - For each event with viewport bounds (vbx0, vby0, vtx0, vty0):
    1. Calculate grid cell_size at that zoom level
    2. Determine all complete cells within viewport rectangle
    3. Store as: `{event_id: [(i1,j1), (i2,j2), ...], viewport_bounds: {...}, zoom_level: ...}`
  - Export JSON for downstream use (training context-aware models)
  - Report: "Calculated visible patches for N events; avg M patches per viewport"

**Constraints:**
- DZI approach (default): requires local tile directory or S3 access
- OpenSlide approach (optional): requires openslide-python + original slide files
- Batch processing with progress bars (tqdm)
- Skip edge cells (partial cells) in visible patch calculation
- Memory-efficient: process one event at a time, don't load entire slide
- Validate coordinates before extraction (catch out-of-bounds errors)

**Test notes:**
- Extract patches from 10 sample clicks in CSV
- Visually inspect alignment (do patches show clicked regions?)
- Compare DZI-extracted vs OpenSlide-extracted patches (if both available)
- Verify visible patch calculation includes correct cell indices
- Test with events at different zoom levels (2.5×, 5×, 20×, 40×)

**Deliverables:**
- `analysis/scripts/extract_patches.py` - Patch extraction from DZI/OpenSlide
- `analysis/scripts/calculate_visible_patches.py` - Visible patch calculator
- `analysis/scripts/lattice_utils.py` - Shared lattice math utilities (ported from TypeScript)
- Updated `analysis/requirements.txt` - Add pillow, tqdm, openslide-python (optional)
- Updated `analysis/README.md` - Document patch extraction usage

